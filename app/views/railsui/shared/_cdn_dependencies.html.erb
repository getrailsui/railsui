<!-- Stylesheets -->
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
<style>
  /* Shiki code block styles */
  .shiki {
    background: transparent !important;
    padding: 1rem;
    overflow-x: auto;
  }
  .shiki code {
    display: block;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 1rem;
    line-height: 1.7;
  }
  /* Dark theme adjustments */
  pre code {
    background: transparent !important;
  }
</style>

<!-- Import map for ES modules (required for railsui-stimulus package) -->
<script type="importmap">
{
  "imports": {
    "@hotwired/stimulus": "https://unpkg.com/@hotwired/stimulus@3.2.2/dist/stimulus.js",
    "tippy.js": "https://unpkg.com/tippy.js@6.3.7/dist/tippy.esm.js"
  }
}
</script>

<!-- Core Dependencies -->
<script src="https://unpkg.com/@hotwired/stimulus@3.2.2/dist/stimulus.umd.js"></script>
<script src="https://unpkg.com/stimulus-use@0.52.2/dist/index.umd.js"></script>

<!-- UI Libraries -->
<script src="https://unpkg.com/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
<%= javascript_include_tag "https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js", defer: true %>

<!-- Syntax Highlighting with Shiki -->
<script type="module">
  import { codeToHtml, bundledLanguages } from 'https://esm.sh/shiki@1.22.0';

  // Language mapping for code blocks
  const languageMap = {
    'language-ruby': 'ruby',
    'language-erb': 'erb',
    'language-html': 'html',
    'language-javascript': 'javascript',
    'language-js': 'javascript',
    'language-bash': 'bash',
    'language-shell': 'bash',
    'language-css': 'css',
    'language-xml': 'xml',
    'language-haml': 'ruby'
  };

  // Highlight a single code element
  async function highlightElement(codeEl) {
    if (codeEl.dataset.shikiHighlighted) return;

    const classNames = Array.from(codeEl.classList);
    const langClass = classNames.find(c => c.startsWith('language-'));
    const lang = languageMap[langClass] || 'text';

    // Check if language is available
    const availableLang = bundledLanguages[lang] ? lang : 'text';

    try {
      const code = codeEl.textContent;
      const html = await codeToHtml(code, {
        lang: availableLang,
        theme: 'material-theme-palenight'
      });

      // Replace pre>code with Shiki output
      const preEl = codeEl.parentElement;
      if (preEl && preEl.tagName === 'PRE') {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        const shikiPre = wrapper.firstChild;
        const shikiCode = shikiPre.querySelector('code');

        // Preserve original pre classes
        preEl.classList.forEach(c => shikiPre.classList.add(c));

        // Transfer data attributes for clipboard functionality
        if (shikiCode) {
          Array.from(codeEl.attributes).forEach(attr => {
            if (attr.name.startsWith('data-')) {
              shikiCode.setAttribute(attr.name, attr.value);
            }
          });
          // Store original text for clipboard
          shikiCode.dataset.clipboardText = code;
        }

        preEl.replaceWith(shikiPre);
      }
      codeEl.dataset.shikiHighlighted = 'true';
    } catch (e) {
      console.warn('Shiki highlighting failed for', lang, e);
    }
  }

  // Highlight all visible code blocks
  async function highlightAll() {
    const codeElements = document.querySelectorAll('pre code[class*="language-"]');
    for (const el of codeElements) {
      if (el.offsetParent !== null) {
        await highlightElement(el);
      }
    }
  }

  // Expose for use by Alpine.js tab switching
  window.shikiHighlight = {
    highlightElement,
    highlightAll
  };

  // Initial highlight on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', highlightAll);
  } else {
    highlightAll();
  }
</script>

<!-- Initialize Stimulus and register controllers -->
<script>
  (function() {
    // Capture Stimulus globals before reassigning
    const StimulusController = Stimulus.Controller
    const StimulusApplication = Stimulus.Application

    const application = StimulusApplication.start()

    // Expose both application and Controller base class
    window.Stimulus = {
      application: application,
      Controller: StimulusController,
      Application: StimulusApplication
    }

    const { useTransition, useClickOutside } = window.StimulusUse || {}

    <%= render partial: "railsui/shared/inline_controllers" %>;
  })()
</script>
